# Mise configuration for UniFi Oracle Cloud deployment
# https://mise.jdx.dev

[tools]
terraform = "1.14.3"
python = "3.12"
pipx = "latest"
ansible = "13.2.0"
pre-commit = "latest"

[env]
_.file = ".env"

[tasks.ansible-setup]
description = "Install Ansible collections"
run = "cd ansible && ansible-galaxy collection install -r requirements.yml"

[tasks.init]
description = "Initialize Terraform"
run = "cd terraform && terraform init"

[tasks.migrate_backend]
description = "Migrate Terraform state"
run = "cd terraform && terraform init -migrate-state"

[tasks.upgrade]
description = "Initialize Terraform with upgrade"
run = "cd terraform && terraform init --upgrade"

[tasks.plan]
description = "Plan Terraform deployment"
run = "cd terraform && terraform plan"

[tasks.deploy]
description = "ğŸš€ Deploy complete UniFi infrastructure (ONE COMMAND!)"
run = "cd terraform && terraform apply -auto-approve"

[tasks.apply]
description = "Apply Terraform deployment with confirmation"
run = "cd terraform && terraform apply"

[tasks.destroy]
description = "Destroy Terraform infrastructure"
run = "cd terraform && terraform destroy"

[tasks.status]
description = "Check UniFi installation status"
run = """
  IP=$(cd terraform && terraform output -raw instance_public_ip 2>/dev/null)
  if [ -z "$IP" ]; then
    echo "âŒ Infrastructure not deployed yet. Run 'mise run deploy' first."
    exit 1
  fi
  echo "ğŸ” Checking installation status on $IP..."
  ssh -o StrictHostKeyChecking=no ubuntu@$IP 'cat /var/log/unifi-installation-complete.txt 2>/dev/null || echo "â³ Installation still in progress..."'
"""

[tasks.logs]
description = "View UniFi installation logs in real-time"
run = """
  IP=$(cd terraform && terraform output -raw instance_public_ip 2>/dev/null)
  if [ -z "$IP" ]; then
    echo "âŒ Infrastructure not deployed yet. Run 'mise run deploy' first."
    exit 1
  fi
  echo "ğŸ“‹ Showing installation logs from $IP (Ctrl+C to exit)..."
  ssh -o StrictHostKeyChecking=no ubuntu@$IP 'tail -f /var/log/unifi-install.log'
"""

[tasks.ssh]
description = "SSH into the UniFi server"
run = """
  IP=$(cd terraform && terraform output -raw instance_public_ip 2>/dev/null)
  if [ -z "$IP" ]; then
    echo "âŒ Infrastructure not deployed yet. Run 'mise run deploy' first."
    exit 1
  fi
  echo "ğŸ” Connecting to $IP..."
  ssh ubuntu@$IP
"""

[tasks.url]
description = "Show UniFi web interface URL"
run = """
  IP=$(cd terraform && terraform output -raw instance_public_ip 2>/dev/null)
  if [ -z "$IP" ]; then
    echo "âŒ Infrastructure not deployed yet. Run 'mise run deploy' first."
    exit 1
  fi
  echo ""
  echo "ğŸŒ UniFi OS Web Interface:"
  echo "   https://$IP:11443"
  echo ""
"""

[tasks.ansible-inventory]
description = "Show Ansible inventory from Terraform state"
run = "cd ansible && ansible-inventory --list"

[tasks.ansible-graph]
description = "Show Ansible inventory graph"
run = "cd ansible && ansible-inventory --graph"

[tasks.ansible-ping]
description = "Test Ansible connectivity to UniFi server"
run = "cd ansible && ansible unifi_servers -m ping"

[tasks.ansible-run]
description = "Run Ansible playbook manually"
run = "cd ansible && ansible-playbook playbook.yml"

[tasks.ansible-check]
description = "Run Ansible playbook in check mode (dry-run)"
run = "cd ansible && ansible-playbook playbook.yml --check --diff"

[tasks.ansible-tags]
description = "List available Ansible tags"
run = "cd ansible && ansible-playbook playbook.yml --list-tags"

[tasks.pre-commit-install]
description = "Install pre-commit hooks"
run = "pre-commit install"

[tasks.pre-commit-run]
description = "Run pre-commit on all files"
run = "pre-commit run --all-files"

[tasks.pre-commit-update]
description = "Update pre-commit hooks"
run = "pre-commit autoupdate"

[tasks.lint]
description = "Run all linters (pre-commit + ansible-lint)"
run = """
  echo "ğŸ” Running pre-commit hooks..."
  pre-commit run --all-files
  echo ""
  echo "ğŸ” Running ansible-lint..."
  cd ansible && ansible-lint
"""

[tasks.ansible-lint]
description = "Run Ansible linting"
run = "cd ansible && ansible-lint"

[tasks.backend-setup]
description = "ğŸ—„ï¸  Setup OCI Object Storage backend for tfstate (recommended)"
run = """
  echo "ğŸ—„ï¸  Setting up OCI Object Storage backend for Terraform state..."
  echo ""
  echo "This will create a bucket in OCI Object Storage (Always Free)."
  echo ""

  cd terraform/backend-setup

  # Check if .env exists
  if [ ! -f .env ]; then
    echo "Creating symlink to main .env..."
    ln -s ../../.env .env
  fi

  terraform init
  terraform apply

  echo ""
  echo "ğŸ“‹ Follow the instructions above to complete backend configuration."
"""

[tasks.setup]
description = "Initial setup - run this first"
run = "mise install"
depends_post = ['ansible-setup','pre-commit-install']
