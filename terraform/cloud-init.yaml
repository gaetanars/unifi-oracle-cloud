#cloud-config
# Cloud-init configuration for UniFi OS Server
# Using Podman containers

hostname: ${hostname}
timezone: ${timezone}

# Package management
package_update: true
package_upgrade: true
package_reboot_if_required: false

# Install packages
packages:
  # Base tools
  - apt-transport-https
  - ufw
  - net-tools
  - apt-listchanges
  # Podman and dependencies for UniFi OS Server
  - podman
  - slirp4netns

# Write configuration files
write_files:
  # Unattended upgrades configuration
  - path: /etc/apt/apt.conf.d/50unattended-upgrades
    permissions: '0644'
    content: |
      Unattended-Upgrade::Allowed-Origins {
          "$${distro_id}:$${distro_codename}";
          "$${distro_id}:$${distro_codename}-security";
          "$${distro_id}ESMApps:$${distro_codename}-apps-security";
          "$${distro_id}ESM:$${distro_codename}-infra-security";
      };
      Unattended-Upgrade::AutoFixInterruptedDpkg "true";
      Unattended-Upgrade::MinimalSteps "true";
      Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
      Unattended-Upgrade::Remove-New-Unused-Dependencies "true";
      Unattended-Upgrade::Remove-Unused-Dependencies "true";
      Unattended-Upgrade::Automatic-Reboot "true";
      Unattended-Upgrade::Automatic-Reboot-Time "03:00";

  - path: /etc/apt/apt.conf.d/20auto-upgrades
    permissions: '0644'
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Download-Upgradeable-Packages "1";
      APT::Periodic::AutocleanInterval "7";
      APT::Periodic::Unattended-Upgrade "1";

  # UFW Application Profile for UniFi OS Server
  - path: /etc/ufw/applications.d/unifi
    permissions: '0644'
    content: |
      [UniFi]
      title=UniFi OS Server
      description=UniFi OS Server - Complete suite (Network, Protect, Talk, Access)
      ports=3478/udp|5005/tcp|5514/tcp|6789/tcp|8080/tcp|8443/tcp|8843/tcp|8444/tcp|8880/tcp|8881/tcp|8882/tcp|9543/tcp|10003/tcp|11443/tcp

# Commands to run after package installation
runcmd:
  # Download and install UniFi OS Server
  - curl -fsSL -o /tmp/unifi-os-server.run ${unifi_os_server_download_url}
  - chmod +x /tmp/unifi-os-server.run
  - /tmp/unifi-os-server.run install <<EOF
  - y
  - EOF
  - rm -f /tmp/unifi-os-server.run

  # Configure UFW Firewall with Application Profiles
  # Defense in depth: UFW protects ports, OCI Security Lists filter IPs
  - ufw --force reset
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw logging on
  - ufw app update all
  - ufw allow OpenSSH comment 'SSH - IP restrictions in OCI Security Lists'
  - ufw allow UniFi comment 'UniFi OS Server - All ports'
  - echo "y" | ufw enable
